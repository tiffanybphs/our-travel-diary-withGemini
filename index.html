<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Travel Diary ğŸŒ¸</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                    colors: {
                        sakura: {
                            light: '#FFF0F5', // æ·ºç²‰èƒŒæ™¯
                            main: '#FFD1DC',  // æ«»èŠ±ç²‰
                            dark: '#FFB7C5',  // æ·±ç²‰æŒ‰éˆ•
                        },
                        cream: '#FFF9E3',     // ç±³é»ƒåº•è‰²
                        sky: '#B0E0E6',       // æ·¡ç²‰è—
                        cocoa: '#8B4513',     // æ–‡å­—ä¸»è‰²
                        gray: {
                            warm: '#F5F5F0'
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(255, 209, 220, 0.5)',
                        'floating': '0 10px 30px -5px rgba(139, 69, 19, 0.15)',
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <style>
        /* å…¨å±€æ¨£å¼å¾®èª¿ */
        body {
            background-color: #FFF9E3; /* ç±³é»ƒè‰²èƒŒæ™¯ */
            color: #5D4037; /* æ·±å¯å¯è‰²æ–‡å­— */
            -webkit-font-smoothing: antialiased;
        }
        
        /* éš±è— Scrollbar ä½†ä¿æŒæ»‘å‹•åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* æ‹–æ‹½æ™‚çš„æ¨£å¼ */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #FFF0F5;
        }
        .sortable-drag {
            transform: scale(1.05);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            cursor: grabbing;
        }
        
        /* Loading å‹•ç•« */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #FFD1DC;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="app" class="pb-24 max-w-md mx-auto bg-white min-h-screen relative shadow-2xl overflow-hidden">
    
    <div v-if="!supabaseConfigured" class="fixed inset-0 z-[100] bg-cream flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-[30px] shadow-floating w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-sakura-dark mb-4">ğŸŒ¸ æ­¡è¿ä¾†åˆ°æ—…éŠæ‰‹å¸³</h2>
            <p class="text-sm text-gray-500 mb-6">è«‹è¼¸å…¥æ‚¨çš„ Supabase è¨­å®šä»¥é€£æ¥è³‡æ–™åº«</p>
            
            <input v-model="tempUrl" placeholder="Supabase URL" class="w-full mb-3 p-3 rounded-xl bg-gray-50 border border-sakura-main focus:outline-none focus:ring-2 focus:ring-sakura-dark">
            <input v-model="tempKey" placeholder="Supabase Anon Key" class="w-full mb-6 p-3 rounded-xl bg-gray-50 border border-sakura-main focus:outline-none focus:ring-2 focus:ring-sakura-dark">
            
            <button @click="saveConfig" class="w-full bg-sakura-main text-white py-3 rounded-full font-bold shadow-soft active:scale-95 transition">
                é–‹å§‹æ—…ç¨‹ âœˆï¸
            </button>
        </div>
    </div>

    <div v-else>
        <header class="relative h-72">
            <img src="https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?q=80&w=2070&auto=format&fit=crop" 
                 class="w-full h-full object-cover brightness-90" alt="Cover">
            
            <div class="absolute top-12 left-6 text-white text-shadow">
                <h1 class="text-3xl font-bold tracking-widest mb-1">{{ tripData.title || 'æˆ‘çš„æ—¥æœ¬ä¹‹æ—…' }}</h1>
                <p class="text-sm opacity-90">{{ tripData.dateRange || '2025.04.01 - 04.05' }}</p>
            </div>

            <button @click="showSettings = true" class="absolute top-12 right-6 text-white opacity-80 hover:opacity-100">
                <i class="fa-solid fa-gear text-xl"></i>
            </button>
        </header>

        <div class="relative -mt-10 bg-white rounded-t-[40px] px-4 pt-8 min-h-[500px]">
            
            <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-sm py-2 mb-6 border-b border-gray-100 overflow-x-auto no-scrollbar flex space-x-6 px-2">
                <button v-for="tab in tabs" :key="tab.id" 
                        @click="currentTab = tab.id"
                        class="flex flex-col items-center min-w-[50px] transition-all duration-300"
                        :class="currentTab === tab.id ? 'text-sakura-dark scale-110' : 'text-gray-400'">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center mb-1 transition-colors"
                         :class="currentTab === tab.id ? 'bg-sakura-light' : 'bg-transparent'">
                        <i :class="tab.icon" class="text-xl"></i>
                    </div>
                    <span class="text-xs font-medium">{{ tab.name }}</span>
                </button>
            </div>

            <main>
                <div v-if="currentTab === 'schedule'">
                    <div class="flex space-x-3 overflow-x-auto no-scrollbar mb-6 pb-2">
                        <button v-for="(day, index) in daysList" :key="index"
                                @click="currentDayIndex = index"
                                class="flex-shrink-0 px-4 py-2 rounded-2xl border transition-all"
                                :class="currentDayIndex === index ? 'bg-sakura-main text-white border-sakura-main shadow-soft' : 'bg-white text-gray-400 border-gray-200'">
                            <div class="text-xs text-center">Day {{ index + 1 }}</div>
                            <div class="font-bold">{{ day.dateLabel }}</div>
                        </button>
                    </div>

                    <div ref="sortableList" class="space-y-4 pb-20">
                        <div v-if="loading" class="text-center py-10 text-gray-400">
                            <div class="loader mx-auto mb-2"></div>
                            è¼‰å…¥ä¸­...
                        </div>
                        
                        <div v-else-if="currentDaySchedules.length === 0" class="text-center py-10 text-gray-300">
                            <i class="fa-regular fa-calendar-xmark text-4xl mb-3"></i>
                            <p>é€™å¤©é‚„æ²’æœ‰è¡Œç¨‹å“¦</p>
                        </div>

                        <div v-for="(item, index) in currentDaySchedules" :key="item.id" 
                             :data-id="item.id"
                             class="group relative bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex gap-4 items-start active:scale-[0.98] transition-transform duration-200">
                            
                            <div class="flex flex-col items-center pt-1 min-w-[50px]">
                                <input type="text" inputmode="numeric" 
                                       :value="item.start_time" 
                                       @change="updateTime($event, item, 'start_time')"
                                       class="text-sm font-bold text-gray-600 w-12 text-center bg-transparent focus:bg-sakura-light rounded outline-none mb-1">
                                <div class="h-full w-0.5 bg-gray-100 my-1 group-last:hidden"></div>
                                <div class="text-[10px] text-gray-400 group-last:hidden">{{ item.end_time }}</div>
                            </div>

                            <div class="flex-1">
                                <div v-if="item.type === 'transport'" class="bg-sky/10 p-3 rounded-xl border border-sky/20">
                                    <div class="flex items-center text-sky-700 font-bold mb-1">
                                        <i class="fa-solid fa-train-subway mr-2"></i>
                                        <span>{{ item.from_station || 'èµ·é»' }} âœ {{ item.to_station || 'çµ‚é»' }}</span>
                                    </div>
                                    <p class="text-xs text-sky-600/70">{{ item.notes || 'é»æ“Šç·¨è¼¯è©³ç´°äº¤é€šè³‡è¨Š' }}</p>
                                </div>

                                <div v-else>
                                    <h3 class="font-bold text-gray-700 text-lg mb-1">{{ item.title }}</h3>
                                    <div class="flex items-center text-xs text-gray-400 space-x-3">
                                        <span class="bg-cream text-cocoa px-2 py-0.5 rounded-md">{{ item.category || 'æ™¯é»' }}</span>
                                        <span v-if="item.location"><i class="fa-solid fa-location-dot mr-1"></i>{{ item.location }}</span>
                                    </div>
                                    <div class="flex items-center mt-2 space-x-2">
                                        <input type="text" inputmode="numeric" 
                                            placeholder="60"
                                            :value="parseDuration(item.duration)"
                                            @change="updateDuration($event, item)"
                                            class="w-10 text-center text-xs bg-gray-50 rounded border border-gray-200 py-1">
                                        <span class="text-xs text-gray-400">åˆ†é˜</span>
                                    </div>
                                </div>
                            </div>

                            <div class="handle p-2 text-gray-300 cursor-grab touch-none">
                                <i class="fa-solid fa-grip-lines"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="text-center py-10">
                    <div class="bg-white p-6 rounded-3xl shadow-soft mb-6">
                        <i class="fa-solid fa-file-excel text-4xl text-green-500 mb-4"></i>
                        <h3 class="font-bold text-lg mb-2">åŒ¯å‡ºè¡Œç¨‹è¡¨</h3>
                        <p class="text-sm text-gray-400 mb-4">å°‡è¡Œç¨‹è½‰ç‚º Excel æ ¼å¼åˆ†äº«çµ¦æœ‹å‹</p>
                        <button @click="exportExcel" class="bg-green-500 text-white px-6 py-2 rounded-full font-bold shadow-md active:scale-95 transition">
                            ä¸‹è¼‰ .xlsx
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <button @click="addItem" class="fixed bottom-6 right-6 w-14 h-14 bg-sakura-main text-white rounded-full shadow-floating flex items-center justify-center text-2xl active:scale-90 transition z-50">
            <i class="fa-solid fa-plus"></i>
        </button>

        <div class="text-center text-[10px] text-gray-300 pb-4 mt-8">
            ğŸŒ¸ Tiffany & Benjamin ğŸŒ¸
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

createApp({
    setup() {
        // --- ç‹€æ…‹è®Šæ•¸ ---
        const supabaseConfigured = ref(false);
        const tempUrl = ref('');
        const tempKey = ref('');
        const loading = ref(false);
        const supabase = ref(null);
        
        const showSettings = ref(false);
        const currentTab = ref('schedule');
        const currentDayIndex = ref(0);
        
        // æ¨¡æ“¬æ•¸æ“š (è‹¥è³‡æ–™åº«ç‚ºç©ºæ™‚ä½¿ç”¨)
        const tripData = ref({ title: 'æ±äº¬æ«»èŠ±å­£', start_date: '2025-04-01', end_date: '2025-04-05' });
        const schedules = ref([]);
        
        const tabs = [
            { id: 'schedule', name: 'è¡Œç¨‹', icon: 'fa-solid fa-calendar-day' },
            { id: 'nav', name: 'å°èˆª', icon: 'fa-solid fa-map-location-dot' },
            { id: 'voucher', name: 'æ†‘è­‰', icon: 'fa-solid fa-ticket' },
            { id: 'list', name: 'æ¸…å–®', icon: 'fa-solid fa-clipboard-check' },
            { id: 'money', name: 'è¨˜å¸³', icon: 'fa-solid fa-yen-sign' },
        ];

        // --- Supabase åˆå§‹åŒ– ---
        const initSupabase = () => {
            const storedUrl = localStorage.getItem('sb_url');
            const storedKey = localStorage.getItem('sb_key');
            
            if (storedUrl && storedKey) {
                supabase.value = window.supabase.createClient(storedUrl, storedKey);
                supabaseConfigured.value = true;
                fetchData();
            }
        };

        const saveConfig = () => {
            if(tempUrl.value && tempKey.value) {
                localStorage.setItem('sb_url', tempUrl.value);
                localStorage.setItem('sb_key', tempKey.value);
                initSupabase();
            }
        };

        // --- è³‡æ–™é‚è¼¯ ---
        const daysList = computed(() => {
            // ç°¡å–®ç”¢ç”Ÿæ—¥æœŸé™£åˆ—
            const days = [];
            let curr = new Date(tripData.value.start_date);
            const end = new Date(tripData.value.end_date);
            while (curr <= end) {
                const m = (curr.getMonth() + 1).toString().padStart(2, '0');
                const d = curr.getDate().toString().padStart(2, '0');
                const dayName = curr.toLocaleDateString('en-US', { weekday: 'short' });
                days.push({ 
                    date: curr.toISOString().split('T')[0],
                    dateLabel: `${m}.${d} (${dayName})`
                });
                curr.setDate(curr.getDate() + 1);
            }
            return days;
        });

        const currentDaySchedules = computed(() => {
            if (!daysList.value[currentDayIndex.value]) return [];
            const targetDate = daysList.value[currentDayIndex.value].date;
            return schedules.value
                .filter(s => s.day_date === targetDate)
                .sort((a, b) => a.sort_order - b.sort_order); // ä¾æ“š sort_order æ’åº
        });

        // --- Time Engine: æ™‚é–“è½‰æ›èˆ‡é€£å‹• ---
        const timeToMinutes = (t) => {
            if (!t) return 0;
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        };

        const minutesToTime = (m) => {
            let h = Math.floor(m / 60) % 24;
            let min = m % 60;
            return `${String(h).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
        };

        // æ¨¡ç³Šè¼¸å…¥è™•ç† (ä¾‹å¦‚è¼¸å…¥ 0930 -> 09:30)
        const formatTimeInput = (val) => {
            const clean = val.replace(/\D/g, '');
            if (clean.length === 4) return `${clean.slice(0,2)}:${clean.slice(2,4)}`;
            return val;
        };

        const updateScheduleChain = (list, startIndex = 0) => {
            // éª¨ç‰Œæ•ˆæ‡‰è¨ˆç®—
            for (let i = startIndex; i < list.length; i++) {
                const curr = list[i];
                const startM = timeToMinutes(curr.start_time);
                // è™•ç† duration (PostgreSQL interval è½‰ç‚ºåˆ†é˜ï¼Œé€™è£¡ç°¡åŒ–è™•ç†)
                const durM = parseDuration(curr.duration); 
                
                // è¨ˆç®—çµæŸæ™‚é–“
                curr.end_time = minutesToTime(startM + durM);

                // æ›´æ–°ä¸‹ä¸€å€‹é …ç›®çš„é–‹å§‹æ™‚é–“
                if (list[i + 1]) {
                    list[i + 1].start_time = curr.end_time;
                }
            }
            // TODO: æ­¤è™•æ‡‰å°‡æ›´æ–°å¾Œçš„æ•¸æ“šå¯«å› Supabase
        };

        const parseDuration = (durStr) => {
            // å‡è¨­ DB å­˜çš„æ˜¯ "01:30" æˆ– interval æ ¼å¼ï¼Œé€™è£¡ç°¡åŒ–ç‚ºè½‰æ›æˆåˆ†é˜
            if (!durStr) return 60; // é»˜èª 60 åˆ†é˜
            if (typeof durStr === 'number') return durStr;
            // ç°¡å–®è™•ç† "HH:mm:ss" æˆ– "HH:mm"
            const parts = durStr.split(':');
            return parseInt(parts[0])*60 + parseInt(parts[1]);
        };

        const updateTime = (e, item, field) => {
            let val = formatTimeInput(e.target.value);
            item[field] = val;
            
            // æ‰¾åˆ°è©²é …ç›®åœ¨ç•¶å¤©åˆ—è¡¨ä¸­çš„ index
            const list = currentDaySchedules.value;
            const idx = list.findIndex(i => i.id === item.id);
            if (idx !== -1) {
                updateScheduleChain(list, idx);
            }
        };

        const updateDuration = (e, item) => {
            const mins = parseInt(e.target.value) || 60;
            const h = Math.floor(mins/60);
            const m = mins%60;
            item.duration = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`;
            
            const list = currentDaySchedules.value;
            const idx = list.findIndex(i => i.id === item.id);
            if (idx !== -1) updateScheduleChain(list, idx);
        };

        // --- Drag & Drop å¯¦ä½œ ---
        const sortableInstance = ref(null);
        const sortableList = ref(null);

        const initSortable = () => {
            if (sortableList.value) {
                sortableInstance.value = new Sortable(sortableList.value, {
                    animation: 150,
                    handle: ".handle", // åªèƒ½æ‹–æ‹½æŠŠæ‰‹
                    delay: 500,        // é•·æŒ‰ 0.5 ç§’ (æ‰‹æ©Ÿå„ªåŒ–)
                    delayOnTouchOnly: true,
                    ghostClass: "sortable-ghost",
                    dragClass: "sortable-drag",
                    onEnd: (evt) => {
                        // é‡æ–°æ’åˆ—æ•¸æ“šé †åº
                        const list = [...currentDaySchedules.value];
                        const item = list.splice(evt.oldIndex, 1)[0];
                        list.splice(evt.newIndex, 0, item);
                        
                        // æ›´æ–° sort_order èˆ‡æ™‚é–“é€£å‹•
                        list.forEach((item, index) => item.sort_order = index);
                        updateScheduleChain(list, 0); // å¾é ­é‡æ–°è¨ˆç®—æ™‚é–“
                        
                        // æ›´æ–° UI ç¶å®šçš„åŸå§‹é™£åˆ— (é€™ä¸€æ­¥æ¯”è¼ƒè¤‡é›œï¼Œå› ç‚º schedules æ˜¯å…¨é‡æ•¸æ“š)
                        // é€™è£¡ç°¡åŒ–ï¼šåªæ›´æ–°ç•¶å‰ UIï¼Œå¯¦éš›éœ€å¯«å…¥ DB
                    }
                });
            }
        };

        // --- Excel Export (Part 4 æ ¸å¿ƒ) ---
        const exportExcel = () => {
            const wb = XLSX.utils.book_new();
            // é€™è£¡å¯¦ä½œ Part 4 çš„ 15 åˆ†é˜çŸ©é™£é‚è¼¯ (ç°¡åŒ–ç‰ˆ)
            const wsData = [["æ™‚é–“", ...daysList.value.map(d => d.dateLabel)]];
            
            // ç”¢ç”Ÿ 08:00 - 24:00 çš„åˆ»åº¦
            for(let h=8; h<24; h++) {
                wsData.push([`${String(h).padStart(2,'0')}:00`, ...daysList.value.map(() => "")]);
                wsData.push([`${String(h).padStart(2,'0')}:30`, ...daysList.value.map(() => "")]);
            }
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "è¡Œç¨‹è¡¨");
            XLSX.writeFile(wb, `Our_Travel_Diary_${tripData.value.title}.xlsx`);
        };

        // --- è¼‰å…¥æ•¸æ“š Mock ---
        const fetchData = async () => {
            loading.value = true;
            // å¯¦éš›æ‡‰å‘¼å«: const { data } = await supabase.value.from('schedules').select('*');
            // é€™è£¡ä½¿ç”¨ Mock æ•¸æ“šå±•ç¤ºæ•ˆæœ
            setTimeout(() => {
                schedules.value = [
                    { id: 1, day_date: '2025-04-01', type: 'activity', title: 'é›·é–€', start_time: '10:00', duration: '01:00', location: 'æ·ºè‰', category: 'æ™¯é»', sort_order: 0 },
                    { id: 2, day_date: '2025-04-01', type: 'transport', title: 'ç§»å‹•', from_station: 'æ·ºè‰', to_station: 'ä¸Šé‡', start_time: '11:00', duration: '00:30', sort_order: 1 },
                    { id: 3, day_date: '2025-04-01', type: 'activity', title: 'é˜¿ç¾æ©«ç”º', start_time: '11:30', duration: '02:00', location: 'ä¸Šé‡', category: 'è³¼ç‰©', sort_order: 2 },
                ];
                loading.value = false;
                nextTick(() => initSortable());
            }, 800);
        };

        onMounted(() => {
            initSupabase();
        });

        watch(currentTab, (newVal) => {
            if(newVal === 'schedule') {
                nextTick(() => initSortable());
            }
        });

        watch(currentDayIndex, () => {
            nextTick(() => initSortable());
        });

        return {
            supabaseConfigured, tempUrl, tempKey, saveConfig,
            tripData, daysList, currentTab, tabs, currentDayIndex,
            currentDaySchedules, updateTime, updateDuration, parseDuration,
            loading, sortableList, addItem: () => alert('é–‹å•Ÿæ–°å¢è¦–çª— (å°šæœªå¯¦ä½œ)'),
            exportExcel, showSettings
        };
    }
});
</script>
</body>
</html>
